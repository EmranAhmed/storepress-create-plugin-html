const [
          defaultJSConfig,
          defaultModuleConfig,
      ]                                            = require('@wordpress/scripts/config/webpack.config');
const {
          requestToExternal,
          requestToHandle,
          requestToExternalModule,
          getFile,
          getRootFile,
          getWebPackAlias,
      }                                            = require('./tools/webpack-helpers');
const WoocommerceDependencyExtractionWebpackPlugin = require('@woocommerce/dependency-extraction-webpack-plugin');
const DependencyExtractionWebpackPlugin            = require('@wordpress/dependency-extraction-webpack-plugin');
const RemoveEmptyScriptsPlugin                     = require('webpack-remove-empty-scripts');

const scriptConfig = {
    ...defaultJSConfig,
    entry : {
        [`react-example`]             : [
            getFile('react/index.js'),
        ],

        'storepress-utils' : {
            import  : '@storepress/utils/build-module/index.js',
            library : {
                name    : ['StorePress', 'Utils'],
                type : 'window',
            },
        },

        [`script-example`] : [
            getFile('storepress/style.scss'),
            getFile('storepress/script.js'),
        ],
    },

    resolve : {
        ...defaultJSConfig.resolve,
        alias : {
            ...defaultJSConfig.resolve.alias,
            ...getWebPackAlias(),
        },
    },

    plugins : [
        ...defaultJSConfig.plugins,
        ...defaultJSConfig.plugins.filter(
            (plugin) =>
                plugin.constructor.name !== 'DependencyExtractionWebpackPlugin'
        ),

        new DependencyExtractionWebpackPlugin({
            requestToExternal,
            requestToHandle,
            requestToExternalModule,
        }),

        // Removes the empty `.js` files generated by webpack but
        // sets it after WP has generated its `*.asset.php` file.
        new RemoveEmptyScriptsPlugin({
            stage : RemoveEmptyScriptsPlugin.STAGE_AFTER_PROCESS_PLUGINS,
        }),
    ],
}

const moduleConfig = {
    ...defaultModuleConfig,
    entry : {
        'interactive-example' : getFile('interactive/index.js'),
        'storepress-utils-module': {
            import: '@storepress/utils/build-module/index.js',
            library: {
                type: 'module',
            },
        },

        [`module-example`] : [
            getFile('storepress/style.scss'),
            getFile('storepress/script.js'),
        ],
    },

    resolve : {
        ...defaultModuleConfig.resolve,
        alias : {
            ...defaultModuleConfig.resolve.alias,
            ...getWebPackAlias(),
        },
    },

    plugins : [
        ...defaultModuleConfig.plugins,

        ...defaultModuleConfig.plugins.filter(
            (plugin) =>
                plugin.constructor.name !== 'DependencyExtractionWebpackPlugin'
        ),

        new DependencyExtractionWebpackPlugin({
            requestToExternal,
            requestToHandle,
            requestToExternalModule,
        }),

        // Removes the empty `.js` files generated by webpack but
        // sets it after WP has generated its `*.asset.php` file.
        new RemoveEmptyScriptsPlugin({
            stage : RemoveEmptyScriptsPlugin.STAGE_AFTER_PROCESS_PLUGINS,
        }),
    ],
};

module.exports = [scriptConfig, moduleConfig];
