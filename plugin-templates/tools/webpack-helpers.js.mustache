// @see: https://developer.wordpress.org/block-editor/reference-guides/packages/packages-dependency-extraction-webpack-plugin/
/**
 * External dependencies
 */
const {getProjectSourcePath} = require('@wordpress/scripts/utils/config');
const {fromProjectRoot}      = require('@wordpress/scripts/utils/file');
const {sep}                  = require('path');

// jquery --> window.jQuery
// react-dom --> window.ReactDOM
// Add `slick-carousel`, `@woocommerce/blocks-registry`,`@woocommerce/settings` on `.eslintrc.js` -> 'import/core-modules'
const externalScriptsMap = {
    '@storepress/utils' : ['StorePress', 'Utils'],
};

// @babel/runtime/regenerator --> wp-polyfill
const scriptHandleMap = {
    '@storepress/utils' : 'storepress-utils',
};

const externalModulesMap = {
          //  1. static import.
          // '@wordpress/a11y': 'import @wordpress/a11y',
          // '@storepress/utils': 'import @storepress/utils',

          // view.js <script type="module" src="./view.js"></script>
          // import { ... } from '@storepress/utils';

          // 2. dynamic import.
          // '@storepress/utils': 'module @storepress/utils',

          // view.js <script type="module" src="./view.js"></script>
          // import('@storepress/utils').then(()=>{});
          // OR
          // const config = await fetch('../config.json').then(response => response.json());
          // const driver = await import(`@storepress/utils`);
          // driver.connect();

    /*
          ```html
              <script type="importmap">
                  {
                    "imports":
                        {
                            "@wordpress/interactivity":"http://example.com/wp-includes/js/dist/script-modules/interactivity/index.min.js"
                            "@storepress/utils":"./build/storepress-utils-module.js"
                        }
                  }
              </script>

              <link rel="modulepreload" href="http://example.com/wp-includes/js/dist/script-modules/interactivity/index.min.js" fetchpriority="low" />
              <link rel="modulepreload" href="./build/storepress-utils-module.js" fetchpriority="low" />
              ```*/

          // in view.js
          // ```js
          // "import" prefix — static import (top-level, resolved at load time)
          // import { store, getContext } from '@wordpress/a11y';
          // ```

          // dynamic import.
          // @see: https://github.com/WordPress/gutenberg/blob/trunk/packages/block-library/src/query/view.js#L40
          // ```js
          //  import('@wordpress/interactivity-router').then({});
          // ```
          // '@wordpress/interactivity-router': 'import @wordpress/interactivity-router',

          // view.js

          // "import" prefix — static import (top-level, resolved at load time)
          //  import { store, getContext } from '@wordpress/interactivity';

          // "module" prefix — dynamic import (lazy, resolved at runtime)
          // const loadRouter = () => import('@wordpress/interactivity-router');
      }
;

/**
 * Default request to global transformation
 *
 * Transform @wordpress dependencies:
 * - request `@wordpress/api-fetch` becomes `[ 'wp', 'apiFetch' ]`
 * - request `@wordpress/i18n` becomes `[ 'wp', 'i18n' ]`
 *
 * @param  {string} request Module request (the module name in `import from`) to be transformed
 * @return {string|string[]|undefined} The resulting external definition. Return `undefined`
 *   to ignore the request. Return `string|string[]` to map the request to an external.
 */
function requestToExternal(request) {
    if (externalScriptsMap[request]) {
        return externalScriptsMap[request];
    }
}

/**
 * Default request to WordPress script handle transformation
 *
 * Transform @wordpress dependencies:
 * - request `@wordpress/i18n` becomes `wp-i18n`
 * - request `@wordpress/escape-html` becomes `wp-escape-html`
 *
 * @param  {string} request Module request (the module name in `import from`) to be transformed
 * @return {string|undefined} WordPress script handle to map the request to. Return `undefined`
 *   to use the same name as the module.
 */
function requestToHandle(request) {
    if (scriptHandleMap[request]) {
        return scriptHandleMap[request];
    }
}

/**
 * Default request to external module transformation
 *
 * Currently Supports:
 * - @wordpress/interactivity
 * - @wordpress/interactivity-router
 *
 * Do not use the boolean shorthand here, it's only handled for the
 * `requestToExternalModule` option.
 *
 * @param {string} request Module request (the module name in `import from`) to be transformed
 * @return {string|Error|undefined} The resulting external definition.
 *   - Return `undefined` to ignore the request (do not externalize).
 *   - Return `string` to map the request to an external.
 *   - Return `Error` to emit an error.
 */
function requestToExternalModule(request) {
    if (externalModulesMap[request]) {
        return externalModulesMap[request];
    }
}

function getFile(fileName) {
    return fromProjectRoot(getProjectSourcePath() + sep + fileName);
}

function getRootFile(fileName) {
    return fromProjectRoot(fileName);
}

function getWebPackAlias() {
    return {
        // '@utils': getFile('utils/Plugin'), // Add @utils on .eslintrc.js -> 'import/core-modules'
        //'@storepress/icons': getFile('packages/icons'),
        //'@storepress/utils': getFile('packages/utils'),
        //'@storepress/components': getFile('packages/components'),
        '@{{kebabNamespace}}/{{kebabSlug}}' : getFile('index.js'),
    };
}

module.exports = {
    getFile,
    getRootFile,
    getWebPackAlias,
    requestToExternal,
    requestToHandle,
    requestToExternalModule,
};
